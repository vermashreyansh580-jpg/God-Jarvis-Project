name: Build VEGA Final Rescue
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libasound2-dev
          python -m pip install --upgrade pip
          # Requirements install karne se pehle file dhoondenge
      
      - name: üìÇ Rescue Files to Root
        run: |
          echo "üîç Operation: Rescue Files started..."
          
          # 1. main.py ko dhoondo aur Root (.) mein lao
          MAIN_PATH=$(find . -name "main.py" -type f | head -n 1)
          if [ -z "$MAIN_PATH" ]; then
            echo "‚ùå CRITICAL: main.py mili hi nahi!"
            exit 1
          fi
          if [ "$MAIN_PATH" != "./main.py" ]; then
            echo "üì¶ Moving main.py from $MAIN_PATH to Root..."
            mv "$MAIN_PATH" ./main.py
          fi
          
          # 2. pyproject.toml ko dhoondo aur Root (.) mein lao
          CONF_PATH=$(find . -name "pyproject.toml" -type f | head -n 1)
          if [ ! -z "$CONF_PATH" ] && [ "$CONF_PATH" != "./pyproject.toml" ]; then
             echo "üì¶ Moving pyproject.toml from $CONF_PATH to Root..."
             mv "$CONF_PATH" ./pyproject.toml
          fi
          
          # 3. requirements.txt ko dhoondo aur Root (.) mein lao
          REQ_PATH=$(find . -name "requirements.txt" -type f | head -n 1)
          if [ ! -z "$REQ_PATH" ] && [ "$REQ_PATH" != "./requirements.txt" ]; then
             echo "üì¶ Moving requirements.txt from $REQ_PATH to Root..."
             mv "$REQ_PATH" ./requirements.txt
          fi
          
          echo "‚úÖ Files Rescued. Current Directory Structure:"
          ls -la
          
      - name: Install Python Libraries
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            # Backup agar file na mile
            pip install flet requests SpeechRecognition pyttsx3 plyer
          fi

      - name: üöÄ Build APK (Force Main)
        run: |
          # Ab files Root mein hain, toh hum '.' use karenge
          # Aur zabardasti batayenge ki module 'main' hai
          yes | flet build apk . --module-name main --verbose
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VEGA-GOD-MODE
          path: "*.apk"

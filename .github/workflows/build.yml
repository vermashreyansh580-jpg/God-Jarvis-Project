name: Build VEGA Direct Target
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libasound2-dev
          python -m pip install --upgrade pip
      
      - name: üìÇ Move Files to Root (Safest Way)
        run: |
          # 1. Sabse pehle main.py dhoond kar Root par lao
          MAIN_PATH=$(find . -name "main.py" -type f | head -n 1)
          if [ -z "$MAIN_PATH" ]; then
            echo "‚ùå ERROR: main.py mili hi nahi!"
            exit 1
          fi
          if [ "$MAIN_PATH" != "./main.py" ]; then
            mv "$MAIN_PATH" ./main.py
          fi
          
          # 2. pyproject.toml ko bhi Root par lao (Permissions ke liye)
          CONF_PATH=$(find . -name "pyproject.toml" -type f | head -n 1)
          if [ ! -z "$CONF_PATH" ] && [ "$CONF_PATH" != "./pyproject.toml" ]; then
             mv "$CONF_PATH" ./pyproject.toml
          fi

          # 3. requirements.txt ko bhi lao
          REQ_PATH=$(find . -name "requirements.txt" -type f | head -n 1)
          if [ ! -z "$REQ_PATH" ] && [ "$REQ_PATH" != "./requirements.txt" ]; then
             mv "$REQ_PATH" ./requirements.txt
          fi
          
          echo "‚úÖ Files Moved. Ready to Build."
          ls -la
          
      - name: Install Python Libraries
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install flet requests SpeechRecognition pyttsx3 plyer
          fi

      - name: üöÄ Build APK (Direct File Target)
        run: |
          # üî• YAHAN CHANGE HAI: Hum Folder (.) nahi, seedha File de rahe hain.
          # Flet file ko build karega, aur bagal me padi config file se permissions le lega.
          yes | flet build apk main.py --verbose
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VEGA-GOD-MODE
          path: "*.apk"

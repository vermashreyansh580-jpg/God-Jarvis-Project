name: Build VEGA Reconstruction
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libasound2-dev
          python -m pip install --upgrade pip
          pip install flet requests SpeechRecognition pyttsx3 plyer
      
      - name: üèóÔ∏è Create Clean Workspace
        run: |
          echo "üßπ Creating a clean build environment..."
          mkdir vega_build_env
          
          # 1. Main.py ko dhoond kar naye folder mein copy karo
          MAIN_FILE=$(find . -name "main.py" -type f | head -n 1)
          if [ -z "$MAIN_FILE" ]; then
            echo "‚ùå CRITICAL: main.py mili hi nahi!"
            exit 1
          fi
          echo "‚úÖ Found main.py at: $MAIN_FILE"
          cp "$MAIN_FILE" vega_build_env/main.py
          
          # 2. Requirements copy karo (agar hai)
          REQ_FILE=$(find . -name "requirements.txt" -type f | head -n 1)
          if [ ! -z "$REQ_FILE" ]; then
             cp "$REQ_FILE" vega_build_env/requirements.txt
          fi
          
          # 3. Config File (pyproject.toml) ko SCRIPT SE BANAO
          # Taaki koi purani galti na rahe.
          echo "üìù Generating fresh pyproject.toml..."
          
          cat <<EOF > vega_build_env/pyproject.toml
          [tool.flet]
          product_name = "VEGA AI"
          org = "com.shrey.vega"
          description = "System AI"
          
          [tool.flet.app]
          path = "main.py"
          
          [tool.flet.android]
          build_number = 1
          permissions = [
            "INTERNET",
            "RECORD_AUDIO",
            "FOREGROUND_SERVICE",
            "WAKE_LOCK",
            "MODIFY_AUDIO_SETTINGS",
            "READ_EXTERNAL_STORAGE",
            "WRITE_EXTERNAL_STORAGE",
            "MANAGE_EXTERNAL_STORAGE",
            "SYSTEM_ALERT_WINDOW",
            "ACCESS_NETWORK_STATE",
            "QUERY_ALL_PACKAGES"
          ]
          
          [tool.flet.android.manifest]
          "android:foregroundServiceType" = "microphone"
          "android:requestLegacyExternalStorage" = "true"
          "android:usesCleartextTraffic" = "true"
          "android:manageSpaceActivity" = "com.shrey.vega.MainActivity"
          EOF
          
          echo "‚úÖ Clean Environment Ready:"
          ls -R vega_build_env
          
      - name: üöÄ Build APK from Clean Room
        run: |
          # Naye folder ke andar jao
          cd vega_build_env
          
          # Ab yahan sirf main.py aur config hai. Confusion impossible hai.
          echo "üî® Starting Flet Build..."
          yes | flet build apk . --verbose
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VEGA-GOD-MODE
          path: "vega_build_env/build/apk/*.apk"

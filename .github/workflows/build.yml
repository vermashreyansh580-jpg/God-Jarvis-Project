name: Build VEGA God Injection
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libasound2-dev
          python -m pip install --upgrade pip
          pip install flet requests SpeechRecognition pyttsx3 plyer
      
      - name: üõ†Ô∏è FORCE CREATE FILES (No Searching)
        run: |
          echo "üî• Creating main.py directly..."
          
          # --- PYTHON CODE START ---
          cat <<EOF > main.py
          import flet as ft
          import speech_recognition as sr
          import threading
          import time
          from plyer import tts

          # --- VEGA CONFIG ---
          WAKE_WORD = "vega"

          class GhostVega:
              def __init__(self, page):
                  self.page = page
                  self.recognizer = sr.Recognizer()

              def speak(self, text):
                  try:
                      print(f"VEGA: {text}")
                      tts.speak(text) 
                  except:
                      pass

              def background_listen(self, visual_feedback):
                  with sr.Microphone() as source:
                      self.recognizer.adjust_for_ambient_noise(source)
                      while True:
                          try:
                              visual_feedback("LISTENING...", "green")
                              audio = self.recognizer.listen(source, phrase_time_limit=5)
                              visual_feedback("PROCESSING...", "blue")
                              
                              text = self.recognizer.recognize_google(audio).lower()
                              if WAKE_WORD in text:
                                  self.speak("Yes Boss?")
                          except:
                              visual_feedback("STANDBY", "black")
                              pass

          def main(page: ft.Page):
              page.title = "VEGA GOD MODE"
              page.bgcolor = "black"
              page.padding = 20
              page.vertical_alignment = ft.MainAxisAlignment.CENTER
              page.horizontal_alignment = ft.CrossAxisAlignment.CENTER

              # --- PERMISSION HANDLER ---
              def handle_permission_result(e):
                  print(f"Permission result: {e}")

              ph = ft.PermissionHandler(on_callback=handle_permission_result)
              page.overlay.append(ph)

              status_label = ft.Text("TAP TO ACTIVATE", color="red", size=20, weight="bold")
              indicator = ft.Container(width=100, height=100, bgcolor="red", border_radius=50)

              def update_visuals(text, color):
                  status_label.value = text
                  indicator.bgcolor = color
                  page.update()

              def start_vega():
                  vega = GhostVega(page)
                  vega.speak("Access Granted. System Online.")
                  vega.background_listen(update_visuals)

              def request_permissions(e=None):
                  ph.request_permissions([ft.Permission.AUDIO_RECORDING, ft.Permission.STORAGE])
                  status_label.value = "INITIALIZING..."
                  status_label.color = "cyan"
                  page.update()
                  threading.Thread(target=start_vega, daemon=True).start()

              page.add(
                  indicator,
                  ft.Container(height=20),
                  status_label,
                  ft.ElevatedButton("GRANT ACCESS", on_click=request_permissions, bgcolor="red", color="white")
              )

          ft.app(target=main)
          EOF
          # --- PYTHON CODE END ---

          echo "üî• Creating pyproject.toml directly..."
          # --- CONFIG START ---
          cat <<EOF > pyproject.toml
          [tool.flet]
          product_name = "VEGA GOD MODE"
          org = "com.shrey.vega"
          description = "System AI"

          [tool.flet.app]
          path = "main.py"

          [tool.flet.android]
          build_number = 1
          permissions = [
            "INTERNET",
            "RECORD_AUDIO",
            "FOREGROUND_SERVICE",
            "WAKE_LOCK",
            "MODIFY_AUDIO_SETTINGS",
            "READ_EXTERNAL_STORAGE",
            "WRITE_EXTERNAL_STORAGE",
            "MANAGE_EXTERNAL_STORAGE",
            "SYSTEM_ALERT_WINDOW",
            "ACCESS_NETWORK_STATE",
            "QUERY_ALL_PACKAGES"
          ]

          [tool.flet.android.manifest]
          "android:foregroundServiceType" = "microphone"
          "android:requestLegacyExternalStorage" = "true"
          "android:usesCleartextTraffic" = "true"
          "android:manageSpaceActivity" = "com.shrey.vega.MainActivity"
          EOF
          # --- CONFIG END ---
          
          echo "‚úÖ Files Created Successfully!"
          ls -la

      - name: üöÄ Build APK (No Escape)
        run: |
          # Ab file 100% yahin hai, toh build hona hi padega
          yes | flet build apk . --verbose
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VEGA-GOD-MODE
          path: "*.apk"
